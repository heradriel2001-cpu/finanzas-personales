<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<!-- PWA -->
<link rel="manifest" href="/finanzas-personales/manifest.json">
<meta name="theme-color" content="#0b0e14">

<title>Finanzas personales</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
 --bg:#0b0e14;--card:#151a24;--txt:#fff;
 --accent:#4cafef;--ok:#4caf50;--bad:#ff5252;--muted:#9aa4b2;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--txt)}
header{padding:14px;text-align:center;font-weight:600;background:#0f1320}
main{padding:14px;padding-bottom:80px}
.card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:14px}
input,select,button{
 width:100%;padding:10px;margin:5px 0;border-radius:10px;
 border:none;background:#0f1320;color:#fff
}
button{font-weight:600}
.ok{background:var(--ok)}
.bad{background:var(--bad)}
.blue{background:var(--accent)}
.list{background:#0f1320;padding:8px;border-radius:8px;margin:5px 0;font-size:14px}
.small{font-size:.85em;color:var(--muted)}
.row{display:flex;gap:8px}
.row>*{flex:1}
.page{display:none}
nav{
 position:fixed;bottom:0;left:0;right:0;
 display:flex;background:#0f1320
}
nav button{
 flex:1;background:none;color:var(--muted);padding:10px 0
}
nav button.active{color:var(--accent)}
</style>
</head>

<body>

<header>ğŸ’° Finanzas personales</header>

<main>

<!-- ================= MOVIMIENTOS ================= -->
<section id="mov" class="page">

<div class="card">
<h3>â• Movimiento</h3>

<select id="tipo">
<option value="ingreso">Ingreso</option>
<option value="gasto">Gasto</option>
</select>

<input id="desc" placeholder="DescripciÃ³n">
<input id="monto" type="number" placeholder="Monto">

<select id="mon">
<option value="UYU">UYU</option>
<option value="USD">USD</option>
</select>

<select id="categoria" onchange="renderSubs()"></select>

<div id="subcats"></div>

<select id="cuenta"></select>

<button class="ok" onclick="agregar()">Guardar</button>
</div>

<div class="card">
<h3>ğŸ“… Semana actual</h3>
<div id="lista"></div>
<div id="balance"></div>
</div>

</section>

<!-- ================= CUENTAS ================= -->
<section id="cuentas" class="page">
<div class="card">
<h3>ğŸ¦ Cuentas</h3>

<input id="nCuenta" placeholder="Nombre cuenta">
<select id="mCuenta">
<option>UYU</option>
<option>USD</option>
</select>

<button class="blue" onclick="crearCuenta()">Crear cuenta</button>

<div id="listaCuentas"></div>
</div>
<div class="card">
  <h3>ğŸ” Transferir entre cuentas</h3>

  <select id="tOrigen"></select>
  <select id="tDestino"></select>

  <input id="tMonto" type="number" placeholder="Monto">
  
  <button class="blue" onclick="transferir()">Transferir</button>
</div>
</section>

<!-- ================= PRESUPUESTO ================= -->
<section id="pres" class="page">
  <div class="card">
    <h3>ğŸ¯ Presupuesto mensual</h3>

    <input id="objMes" type="month">
    <input id="objAhorro" type="number" placeholder="Objetivo de ahorro">

    <button class="blue" onclick="guardarPresupuesto()">Guardar objetivo</button>

    <div id="sugerencias"></div>

    <!-- ğŸ‘‡ GRÃFICO -->
    <canvas id="grafico" height="180"></canvas>
  </div>
</section>

<!-- ================= BACKUP ================= -->
<section id="backup" class="page">
<div class="card">
<h3>ğŸ›Ÿ Copia de seguridad</h3>

<button class="blue" onclick="exportar()">Exportar datos</button>
<input type="file" onchange="importar(this.files[0])">

</div>
</section>

<!-- ================= DEUDAS ================= -->
<section id="deudas" class="page">

<div class="card">
<h3>ğŸ’³ Nueva deuda</h3>

<input id="dNombre" placeholder="Nombre (ej: PrÃ©stamo USD)">
<input id="dTotal" type="number" placeholder="Monto total">
<select id="dMon">
<option value="USD">USD</option>
<option value="UYU">UYU</option>
</select>

<input id="dCuotas" type="number" placeholder="Cantidad de cuotas">
<input id="dDia" type="number" placeholder="DÃ­a de pago (1-28)">

<select id="dCuenta"></select>

<button class="blue" onclick="crearDeuda()">Guardar deuda</button>
</div>

<div class="card">
<h3>ğŸ“‹ Deudas activas</h3>
<div id="listaDeudas"></div>
</div>

</section>

</main>

<nav>
<button onclick="show('mov')" id="bmov">Mov</button>
<button onclick="show('cuentas')" id="bcuentas">Cuentas</button>
<button onclick="show('pres')" id="bpres">Presupuesto</button>
<button onclick="show('backup')" id="bbackup">Backup</button>
<button onclick="show('deudas')" id="bdeudas">Deudas</button>
</nav>

<script>
const DB="finanzas_final";
const USD=40;

const categorias={
 "Servicios":["UTE","OSE","MÃ³vil","Wifi"],
 "Alimentos":["CarnicerÃ­a","Verduras","Fruta","Arroz","Pastas","CafÃ©","Especias"],
 "Gustos":["Dulces","Jugos","Refrescos"],
 "Higiene":["JabÃ³n","Detergente","Suavizante","Shampoo","Acondicionador","Papel"],
 "Otros":["Otros"]
};

let db=JSON.parse(localStorage.getItem(DB));
if(!db){
 db={cuentas:[],movs:[],pres:{},deudas:[]};
 save();
}

function save(){localStorage.setItem(DB,JSON.stringify(db))}

function show(p){
  document.querySelectorAll(".page").forEach(s=>s.style.display="none");
  document.getElementById(p).style.display="block";
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("b"+p).classList.add("active");

  if(p==="pres") analizar();
}

function init(){
 show("mov");
 categoria.innerHTML=Object.keys(categorias)
  .map(c=>`<option>${c}</option>`).join("");
 renderSubs();
 renderCuentas();
 render();
 cargarCuentasEnDeudas();
 cargarSelectTransferencias();
 procesarDeudas();
}

function renderSubs(){
 subcats.innerHTML=categorias[categoria.value]
  .map(s=>`<label class="list">
   <input type="checkbox" value="${s}"> ${s}
  </label>`).join("");
}

function agregar(){
 if(!monto.value||!cuenta.value)return;
 const subs=[...subcats.querySelectorAll("input:checked")].map(i=>i.value);

 const mov={
  tipo:tipo.value,
  desc:desc.value,
  monto:Number(monto.value),
  mon:mon.value,
  cat:categoria.value,
  subs,
  cuenta:cuenta.value,
  fecha:new Date().toISOString().slice(0,10)
 };

 db.movs.push(mov);

 const c=db.cuentas.find(c=>c.id==cuenta.value);
 let v=mov.monto;
 if(mov.mon=="USD"&&c.mon=="UYU")v*=USD;
 if(mov.mon=="UYU"&&c.mon=="USD")v/=USD;
 c.saldo+=mov.tipo=="ingreso"?v:-v;

 save();
 desc.value="";monto.value="";
 render();
 renderCuentas();
}

function render(){
 let html="",ing=0,gas=0;
 db.movs.forEach((m,i)=>{
  let v=m.mon=="USD"?m.monto*USD:m.monto;
  if(m.tipo=="ingreso")ing+=v;else gas+=v;
  html+=`<div class="list">
   ${m.desc||m.cat} â€“ $${m.monto} ${m.mon}
   <div class="small">${m.subs.join(", ")}</div>
  </div>`;
 });
 lista.innerHTML=html;
 balance.innerHTML=`
  <div class="list">Ingresos: $${ing}</div>
  <div class="list">Gastos: $${gas}</div>
  <div class="list"><b>Total: $${ing-gas}</b></div>`;
}

function crearCuenta(){
 if(!nCuenta.value)return;
 db.cuentas.push({
  id:Date.now(),
  nom:nCuenta.value,
  mon:mCuenta.value,
  saldo:0
 });
 nCuenta.value="";
 save();
 renderCuentas();
 cargarCuentasEnDeudas();
 cargarSelectTransferencias();
}

function renderCuentas(){
 cuenta.innerHTML=db.cuentas
  .map(c=>`<option value="${c.id}">${c.nom}</option>`).join("");
 listaCuentas.innerHTML=db.cuentas
  .map(c=>`<div class="list">${c.nom} â€“ $${c.saldo.toFixed(2)} ${c.mon}</div>`).join("");
}

function guardarPresupuesto(){
 if(!objMes.value||!objAhorro.value)return;
 db.pres[objMes.value]=Number(objAhorro.value);
 save();
 analizar();
}

function analizar(){
  const mes=objMes.value;
  const objetivo=db.pres[mes];
  if(!objetivo) return;

  let total=0;
  db.movs.forEach(m=>{
    if(m.tipo=="gasto"){
      let v = m.mon=="USD" ? m.monto*USD : m.monto;
      total += v;
    }
  });

  sugerencias.innerHTML = `
    <div class="list">
      Objetivo ahorro: $${objetivo}<br>
      Gasto total histÃ³rico: $${total}<br>
      ${total>objetivo
        ? "ğŸ”´ EstÃ¡s gastando mÃ¡s de lo recomendado"
        : "ğŸŸ¢ Vas bien"}
    </div>
  `;

  dibujarGrafico();
}

function exportar(){
 const blob=new Blob([JSON.stringify(db)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="finanzas_backup.json";
 a.click();
}

function importar(file){
 const r=new FileReader();
 r.onload=e=>{
  db=JSON.parse(e.target.result);
  save();location.reload();
 };
 r.readAsText(file);
}

init();

function crearDeuda(){
 if(!dNombre.value||!dTotal.value||!dCuotas.value||!dDia.value||!dCuenta.value)return;

 const total=Number(dTotal.value);

 db.deudas.push({
  id:Date.now(),
  nombre:dNombre.value,
  mon:dMon.value,
  total:total,
  restante:total,
  cuotas:Number(dCuotas.value),
  pagadas:0,
  cuota:total/Number(dCuotas.value),
  dia:Number(dDia.value),
  cuenta:dCuenta.value,
  activa:true,
  ultima:null
 });

 dNombre.value="";dTotal.value="";dCuotas.value="";dDia.value="";
 save();
 renderDeudas();
}

function renderDeudas(){
 listaDeudas.innerHTML=db.deudas.map(d=>{
  return `<div class="list">
   <b>${d.nombre}</b><br>
   ${d.pagadas}/${d.cuotas} cuotas |
   Restante: ${d.restante.toFixed(2)} ${d.mon}<br>
   <button class="blue" onclick="toggleDeuda(${d.id})">
    ${d.activa?"Pausar":"Reanudar"}
   </button>
  </div>`;
 }).join("");
}

function toggleDeuda(id){
 const d=db.deudas.find(x=>x.id==id);
 d.activa=!d.activa;
 save();renderDeudas();
}

function procesarDeudas(){
 const hoy=new Date();
 const dia=hoy.getDate();

 db.deudas.forEach(d=>{
  if(!d.activa) return;
  if(d.pagadas>=d.cuotas) return;
  if(d.ultima && d.ultima.startsWith(hoy.toISOString().slice(0,7))) return;
  if(dia<d.dia) return;

  const cuenta=db.cuentas.find(c=>c.id==d.cuenta);
  if(!cuenta) return;

  let montoCuenta=d.cuota;
  if(d.mon=="USD" && cuenta.mon=="UYU") montoCuenta*=USD;
  if(d.mon=="UYU" && cuenta.mon=="USD") montoCuenta/=USD;

  cuenta.saldo-=montoCuenta;
  d.restante-=d.cuota;
  d.pagadas++;
  d.ultima=hoy.toISOString().slice(0,7);

  db.movs.push({
   tipo:"gasto",
   desc:`Cuota ${d.nombre}`,
   monto:d.cuota,
   mon:d.mon,
   cat:"Servicios",
   subs:["Deuda"],
   cuenta:d.cuenta,
   fecha:hoy.toISOString().slice(0,10)
  });
 });

 save();
 render();
 renderCuentas();
 renderDeudas();
}
function cargarCuentasEnDeudas(){
  if(!window.dCuenta) return;
  dCuenta.innerHTML = db.cuentas
    .map(c=>`<option value="${c.id}">${c.nom} (${c.mon})</option>`)
    .join("");
}

function cargarSelectTransferencias(){
  if(!window.tOrigen) return;

  const opts=db.cuentas
    .map(c=>`<option value="${c.id}">${c.nom} (${c.mon})</option>`)
    .join("");

  tOrigen.innerHTML=opts;
  tDestino.innerHTML=opts;
}

function transferir(){
  const o=db.cuentas.find(c=>c.id==tOrigen.value);
  const d=db.cuentas.find(c=>c.id==tDestino.value);
  const monto=Number(tMonto.value);

  if(!o||!d||!monto||o.id==d.id) return;

  let montoOrigen=monto;
  let montoDestino=monto;

  if(o.mon!=d.mon){
    montoDestino = o.mon=="USD" ? monto*USD : monto/USD;
  }

  o.saldo-=montoOrigen;
  d.saldo+=montoDestino;

  db.movs.push({
    tipo:"transfer",
    desc:`Transferencia ${o.nom} â†’ ${d.nom}`,
    monto:montoOrigen,
    mon:o.mon,
    fecha:new Date().toISOString().slice(0,10)
  });

  tMonto.value="";
  save();
  renderCuentas();
  render();
}
tOrigen.onchange = () => {
  const id = tOrigen.value;
  [...tDestino.options].forEach(o=>{
    o.disabled = o.value === id && id !== "";
  });
};

tDestino.onchange = () => {
  const id = tDestino.value;
  [...tOrigen.options].forEach(o=>{
    o.disabled = o.value === id && id !== "";
  });
};
function calcularIngresosYGastos(){
  let ing=0, gas=0;
  const hoy=new Date();
  const desde=new Date();
  desde.setDate(hoy.getDate()-60);

  db.movs.forEach(m=>{
    const f=new Date(m.fecha);
    if(f<desde) return;

    let v=m.mon=="USD"?m.monto*USD:m.monto;
    if(m.tipo=="ingreso") ing+=v;
    if(m.tipo=="gasto") gas+=v;
  });

  return {ing, gas};
}
function dibujarGrafico(){
  const c=document.getElementById("grafico");
  if(!c) return;
  const ctx=c.getContext("2d");

  const {ing, gas}=calcularIngresosYGastos();
  const max=Math.max(ing,gas,1);

  ctx.clearRect(0,0,c.width,c.height);

  const w=c.width;
  const h=c.height;
  const barW=80;

  // ingreso
  const hIng=(ing/max)*(h-40);
  ctx.fillStyle="#4caf50";
  ctx.fillRect(w/4-barW/2,h-hIng-20,barW,hIng);

  // gasto
  const hGas=(gas/max)*(h-40);
  ctx.fillStyle="#ff5252";
  ctx.fillRect(3*w/4-barW/2,h-hGas-20,barW,hGas);

  ctx.fillStyle="#fff";
  ctx.textAlign="center";
  ctx.fillText("Ingresos",w/4,h-5);
  ctx.fillText("Gastos",3*w/4,h-5);

  ctx.fillText("$"+Math.round(ing),w/4,h-hIng-30);
  ctx.fillText("$"+Math.round(gas),3*w/4,h-hGas-30);
}
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/finanzas-personales/sw.js");
  });
}

</script>
</body>
</html>
